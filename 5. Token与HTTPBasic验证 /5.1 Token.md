# 5.1 Token

### 1.Token概述

以下是网站登录和使用API登录的区别

![image.png](https://upload-images.jianshu.io/upload_images/7220971-bd0b117b4d96a154.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

与网站登录不同的是，网站登录将登录信息写入cookie存储在浏览器，而API只负责生成token发送给客户端，而客户端怎么存储有自己决定。
- Token具有有效期
- Token可以标示用户身份，如存储用户id

### 2.获取Token令牌
密码校验--models/user.py
```python
    @staticmethod
    def verify(email, password):
        user = User.query.filter_by(email=email).first()
        if not user:
            raise NotFound('user not found')
        if not user.check_password(password):
            raise AuthFailed()
        return {'uid': user.id}

    def check_password(self, raw):
        if not self._password:
            return False
        return check_password_hash(self._password, raw)
```

返回token的试图函数，这里稍微破坏一下REST的规则，由于登录操作密码安全性较高，使用GET的话会泄漏
```python
@api.route('', methods=['POST'])
def get_token():
    form = ClientForm(request).validate_for_api()
    promise = {
        ClientTypeEnum.USER_EMAIL: User.verify,
    }
    identity = promise[form.type.data](
        form.account.data,
        form.secret.data
    )
    expiration = current_app.config['TOKEN_EXPIRATION']
    token = generator_auth_token(identity['uid'],
                                 form.type.data,
                                 None,
                                 expiration=expiration)
    t = {
        'token': token.decode('utf-8')
    }
    return jsonify(t), 201


def generator_auth_token(uid, ac_type, scope=None,
                         expiration=7200):
    """生成令牌"""
    s = Serializer(current_app.config['SECRET_KEY'],
                   expires_in=expiration)
    return s.dumps({
        'uid': uid,
        'type': ac_type.value
    })
```